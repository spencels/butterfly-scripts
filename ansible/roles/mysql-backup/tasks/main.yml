# Installs MySql backup tool.
- name: Install dependencies (s3cmd).
  apt:
    name: s3cmd
    state: present
  become: yes

- name: Create mysql_backup user exists.
  user:
    name: mysql_backup
    comment: Service account for mysql backup cron jobs.
  become: yes

- name: Add spencels to mysql_backup group.
  user:
    name: spencels
    groups: mysql_backup
    append: yes
  become: yes

- name: Create install directory exists.
  file:
    path: /opt/mysql_backup
    state: directory
    owner: mysql_backup
    group: mysql_backup
    mode: '0550'
  become: yes

- name: Write .s3cfg.
  template:
    src: .s3cfg.j2
    dest: /opt/mysql_backup/.s3cfg
    owner: mysql_backup
    group: mysql_backup
    mode: '0550'
  vars:
    access_key: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        35343666373165616233316562346566646536656230316531323237653232316463646233393063
        3430323461636535663838333266653261643262353661340a326331303839643733656433303263
        65663562313361383730303166643439656262663064613033346231393231623734323935346464
        6635366333326262380a366461333539633438613063623038343737306338623232623466353139
        65356130636364316437643034333835306430666336306536323461656538613237
    secret_key: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        65306232323630366163313934643736663534393865613438343962346633383465356436636530
        6634343337633730386238383437663935656663323337310a643634303335383531316361643030
        32363036383765363265383538336265616366386238393536383332353563373130386339373565
        3836393464363436360a303630333463643165613834376637313838663336363938303433353463
        34653532653634383461663830323135623766396238323466616265313136663032333630656538
        3432616232636635383830326465323964626632303366616364
  become: yes

- name: Write config.py.
  template:
    src: config.py.j2
    dest: /opt/mysql_backup/config.py
    owner: mysql_backup
    group: mysql_backup
    mode: '0550'
  vars: 
    mysql_user: mysql37193
    mysql_password: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        66636637313035373964366334656430313264333034343739393231646565343661636264643066
        3331626464663664646162356531366332346431363166620a303633326433373866373061666162
        33353231323738326230386232363634613566353934336639326638636666646333396564373263
        3039653762653237330a343035396231373635386230346666646263343764623839356162306530
        39386336333264323231326534336532383363396133383434613766343435643466
  become: yes
